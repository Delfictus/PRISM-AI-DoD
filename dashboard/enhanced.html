<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PRISM-AI: Full Fidelity Metrics Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet">
    <!-- Mol* Viewer for 3D visualization -->
    <link rel="stylesheet" type="text/css" href="https://molstar.org/viewer/molstar.css" />
    <script type="text/javascript" src="https://molstar.org/viewer/molstar.js"></script>
    <!-- Chart.js and Plotly for advanced visualizations -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <!-- D3.js for custom visualizations -->
    <script src="https://d3js.org/d3.v7.min.js"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
        }
        .metric-card {
            background: linear-gradient(135deg, #1f2937 0%, #111827 100%);
            border: 1px solid #374151;
        }
        .plddt-excellent { background: #22c55e; }
        .plddt-confident { background: #3b82f6; }
        .plddt-low { background: #eab308; }
        .plddt-very-low { background: #ef4444; }
        .tab-active {
            background: linear-gradient(135deg, #8b5cf6 0%, #6d28d9 100%);
            color: white;
        }
        .quantum-badge {
            background: linear-gradient(135deg, #8b5cf6 0%, #a855f7 100%);
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }
        .heatmap-cell {
            transition: all 0.2s;
        }
        .heatmap-cell:hover {
            stroke: white;
            stroke-width: 2px;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-200 min-h-screen flex flex-col">

    <!-- Enhanced Header with Metrics Bar -->
    <header class="bg-gray-900/95 backdrop-blur-sm border-b border-gray-700 p-3 sticky top-0 z-50">
        <div class="flex justify-between items-center">
            <div class="flex items-center space-x-4">
                <svg class="w-10 h-10 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"/>
                </svg>
                <div>
                    <h1 class="text-2xl font-bold text-white">PRISM-AI Full Fidelity Dashboard</h1>
                    <p class="text-xs text-gray-400">AlphaFold2-Level Metrics + Quantum Enhancements</p>
                </div>
            </div>
            <div class="flex items-center space-x-6">
                <div class="text-center">
                    <div class="text-xs text-gray-400">Active Jobs</div>
                    <span id="active-jobs" class="text-lg font-bold text-white">0</span>
                </div>
                <div class="text-center">
                    <div class="text-xs text-gray-400">GPU Load</div>
                    <span id="gpu-load" class="text-lg font-bold text-green-400">0%</span>
                </div>
                <div class="text-center">
                    <div class="text-xs text-gray-400">API Status</div>
                    <span id="api-status" class="text-sm font-bold text-green-400">Connected</span>
                </div>
            </div>
        </div>
    </header>

    <main class="flex-grow flex">
        <!-- Sidebar with Controls -->
        <aside class="w-80 bg-gray-800/50 border-r border-gray-700 p-4 overflow-y-auto">
            <div class="space-y-4">
                <!-- Input Section -->
                <div class="bg-gray-900 rounded-lg p-4 border border-gray-700">
                    <h3 class="text-lg font-bold mb-3">Protein Input</h3>
                    <textarea id="sequence-input" placeholder="Paste protein sequence here..."
                              class="w-full h-24 bg-gray-800 border border-gray-600 rounded p-2 text-sm font-mono"></textarea>
                    <div class="mt-3 space-y-2">
                        <select id="casp-select" class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-sm">
                            <option value="">Or select CASP target...</option>
                        </select>
                    </div>
                </div>

                <!-- Settings -->
                <div class="bg-gray-900 rounded-lg p-4 border border-gray-700">
                    <h3 class="text-lg font-bold mb-3">Folding Settings</h3>
                    <div class="space-y-3">
                        <div>
                            <label class="text-sm text-gray-400">Number of Models</label>
                            <input type="number" value="5" min="1" max="10" id="num-models"
                                   class="w-full bg-gray-700 border border-gray-600 rounded px-2 py-1 text-sm">
                        </div>
                        <div>
                            <label class="text-sm text-gray-400">MSA Depth</label>
                            <input type="number" value="512" min="32" max="2048" id="msa-depth"
                                   class="w-full bg-gray-700 border border-gray-600 rounded px-2 py-1 text-sm">
                        </div>
                        <div class="space-y-2">
                            <label class="flex items-center text-sm">
                                <input type="checkbox" checked class="mr-2 accent-purple-500">
                                <span class="quantum-badge px-2 py-1 rounded text-xs">Quantum Annealing</span>
                            </label>
                            <label class="flex items-center text-sm">
                                <input type="checkbox" checked class="mr-2 accent-purple-500">
                                <span>Thermodynamic Ensemble</span>
                            </label>
                            <label class="flex items-center text-sm">
                                <input type="checkbox" checked class="mr-2 accent-purple-500">
                                <span>Compare with AlphaFold2</span>
                            </label>
                        </div>
                    </div>
                    <button id="start-folding" class="w-full mt-4 bg-gradient-to-r from-purple-600 to-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:from-purple-700 hover:to-blue-700 transition">
                        Start Folding Analysis
                    </button>
                </div>

                <!-- Job Status -->
                <div class="bg-gray-900 rounded-lg p-4 border border-gray-700">
                    <h3 class="text-lg font-bold mb-3">Job Status</h3>
                    <div id="job-status" class="text-sm space-y-2">
                        <p class="text-gray-400">No active jobs</p>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Main Content Area -->
        <section class="flex-grow flex flex-col">
            <!-- Tabs -->
            <div class="bg-gray-800 border-b border-gray-700">
                <div class="flex">
                    <button onclick="showTab('structure')" class="tab-btn tab-active px-4 py-2 text-sm font-semibold">
                        3D Structure
                    </button>
                    <button onclick="showTab('confidence')" class="tab-btn px-4 py-2 text-sm font-semibold text-gray-400 hover:text-white">
                        Confidence (pLDDT)
                    </button>
                    <button onclick="showTab('pae')" class="tab-btn px-4 py-2 text-sm font-semibold text-gray-400 hover:text-white">
                        PAE Matrix
                    </button>
                    <button onclick="showTab('contacts')" class="tab-btn px-4 py-2 text-sm font-semibold text-gray-400 hover:text-white">
                        Contact Map
                    </button>
                    <button onclick="showTab('ramachandran')" class="tab-btn px-4 py-2 text-sm font-semibold text-gray-400 hover:text-white">
                        Ramachandran
                    </button>
                    <button onclick="showTab('msa')" class="tab-btn px-4 py-2 text-sm font-semibold text-gray-400 hover:text-white">
                        MSA Coverage
                    </button>
                    <button onclick="showTab('domains')" class="tab-btn px-4 py-2 text-sm font-semibold text-gray-400 hover:text-white">
                        Domains
                    </button>
                    <button onclick="showTab('comparison')" class="tab-btn px-4 py-2 text-sm font-semibold text-gray-400 hover:text-white">
                        Comparison
                    </button>
                </div>
            </div>

            <!-- Tab Content -->
            <div class="flex-grow p-4">
                <!-- 3D Structure Tab -->
                <div id="tab-structure" class="tab-content h-full">
                    <div class="h-full bg-gray-900 rounded-lg border border-gray-700 relative">
                        <div class="absolute top-2 left-2 z-10 bg-gray-800/90 rounded px-3 py-1">
                            <select id="model-selector" class="bg-transparent text-sm">
                                <option>Model 1 (Best)</option>
                                <option>Model 2</option>
                                <option>Model 3</option>
                                <option>Model 4</option>
                                <option>Model 5</option>
                            </select>
                        </div>
                        <div id="mol-viewer" class="w-full h-full"></div>
                    </div>
                </div>

                <!-- Confidence Tab -->
                <div id="tab-confidence" class="tab-content hidden h-full">
                    <div class="grid grid-cols-2 gap-4 h-full">
                        <div class="bg-gray-900 rounded-lg border border-gray-700 p-4">
                            <h3 class="text-lg font-bold mb-3">Per-Residue Confidence (pLDDT)</h3>
                            <div class="mb-2 flex items-center space-x-4 text-xs">
                                <span class="flex items-center"><span class="w-3 h-3 plddt-excellent mr-1"></span> >90 (Very High)</span>
                                <span class="flex items-center"><span class="w-3 h-3 plddt-confident mr-1"></span> 70-90 (Confident)</span>
                                <span class="flex items-center"><span class="w-3 h-3 plddt-low mr-1"></span> 50-70 (Low)</span>
                                <span class="flex items-center"><span class="w-3 h-3 plddt-very-low mr-1"></span> <50 (Very Low)</span>
                            </div>
                            <canvas id="plddt-chart" class="w-full h-64"></canvas>
                        </div>
                        <div class="bg-gray-900 rounded-lg border border-gray-700 p-4">
                            <h3 class="text-lg font-bold mb-3">Residue Metrics</h3>
                            <div id="residue-table" class="overflow-y-auto h-64">
                                <table class="w-full text-sm">
                                    <thead class="bg-gray-800 sticky top-0">
                                        <tr>
                                            <th class="px-2 py-1 text-left">Residue</th>
                                            <th class="px-2 py-1 text-left">AA</th>
                                            <th class="px-2 py-1 text-left">pLDDT</th>
                                            <th class="px-2 py-1 text-left">SS</th>
                                            <th class="px-2 py-1 text-left">QC</th>
                                        </tr>
                                    </thead>
                                    <tbody id="residue-tbody"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- PAE Matrix Tab -->
                <div id="tab-pae" class="tab-content hidden h-full">
                    <div class="bg-gray-900 rounded-lg border border-gray-700 p-4 h-full">
                        <h3 class="text-lg font-bold mb-3">Predicted Aligned Error (PAE)</h3>
                        <div id="pae-plot" class="w-full h-5/6"></div>
                        <div class="mt-2 text-xs text-gray-400">
                            Lower values (darker) indicate higher confidence in relative positions
                        </div>
                    </div>
                </div>

                <!-- Contact Map Tab -->
                <div id="tab-contacts" class="tab-content hidden h-full">
                    <div class="bg-gray-900 rounded-lg border border-gray-700 p-4 h-full">
                        <h3 class="text-lg font-bold mb-3">Contact Probability Map</h3>
                        <div id="contact-plot" class="w-full h-5/6"></div>
                    </div>
                </div>

                <!-- Ramachandran Tab -->
                <div id="tab-ramachandran" class="tab-content hidden h-full">
                    <div class="grid grid-cols-2 gap-4 h-full">
                        <div class="bg-gray-900 rounded-lg border border-gray-700 p-4">
                            <h3 class="text-lg font-bold mb-3">Ramachandran Plot</h3>
                            <div id="rama-plot" class="w-full h-80"></div>
                        </div>
                        <div class="bg-gray-900 rounded-lg border border-gray-700 p-4">
                            <h3 class="text-lg font-bold mb-3">Statistics</h3>
                            <div class="space-y-3">
                                <div class="p-3 bg-gray-800 rounded">
                                    <div class="text-sm text-gray-400">Favored Regions</div>
                                    <div class="text-2xl font-bold text-green-400" id="rama-favored">--</div>
                                </div>
                                <div class="p-3 bg-gray-800 rounded">
                                    <div class="text-sm text-gray-400">Allowed Regions</div>
                                    <div class="text-2xl font-bold text-yellow-400" id="rama-allowed">--</div>
                                </div>
                                <div class="p-3 bg-gray-800 rounded">
                                    <div class="text-sm text-gray-400">Outliers</div>
                                    <div class="text-2xl font-bold text-red-400" id="rama-outliers">--</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- MSA Coverage Tab -->
                <div id="tab-msa" class="tab-content hidden h-full">
                    <div class="bg-gray-900 rounded-lg border border-gray-700 p-4 h-full">
                        <h3 class="text-lg font-bold mb-3">Multiple Sequence Alignment Coverage</h3>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <canvas id="msa-chart"></canvas>
                            </div>
                            <div class="space-y-3">
                                <div class="p-3 bg-gray-800 rounded">
                                    <div class="text-sm text-gray-400">Total Sequences</div>
                                    <div class="text-2xl font-bold" id="msa-total">--</div>
                                </div>
                                <div class="p-3 bg-gray-800 rounded">
                                    <div class="text-sm text-gray-400">Effective Sequences</div>
                                    <div class="text-2xl font-bold" id="msa-effective">--</div>
                                </div>
                                <div class="p-3 bg-gray-800 rounded">
                                    <div class="text-sm text-gray-400">Average Coverage</div>
                                    <div class="text-2xl font-bold" id="msa-avg">--</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Domains Tab -->
                <div id="tab-domains" class="tab-content hidden h-full">
                    <div class="bg-gray-900 rounded-lg border border-gray-700 p-4 h-full">
                        <h3 class="text-lg font-bold mb-3">Structural Domains</h3>
                        <div id="domains-visualization" class="h-32 mb-4"></div>
                        <div id="domains-list" class="space-y-3"></div>
                    </div>
                </div>

                <!-- Comparison Tab -->
                <div id="tab-comparison" class="tab-content hidden h-full">
                    <div class="bg-gray-900 rounded-lg border border-gray-700 p-4 h-full overflow-y-auto">
                        <h3 class="text-lg font-bold mb-3">PRISM-AI vs AlphaFold2 Comparison</h3>
                        <div class="grid grid-cols-2 gap-4">
                            <!-- PRISM-AI Metrics -->
                            <div class="bg-gray-800 rounded-lg p-4">
                                <h4 class="text-md font-bold text-purple-400 mb-3">PRISM-AI</h4>
                                <div class="space-y-2 text-sm">
                                    <div class="flex justify-between">
                                        <span class="text-gray-400">Global pLDDT:</span>
                                        <span class="font-bold" id="prism-plddt">--</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-400">TM-Score:</span>
                                        <span class="font-bold" id="prism-tm">--</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-400">RMSD:</span>
                                        <span class="font-bold" id="prism-rmsd">--</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-400">GDT-TS:</span>
                                        <span class="font-bold" id="prism-gdt-ts">--</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-400">Time:</span>
                                        <span class="font-bold text-green-400" id="prism-time">--</span>
                                    </div>
                                    <div class="border-t border-gray-700 pt-2 mt-2">
                                        <div class="text-xs text-purple-400 font-semibold mb-1">Exclusive Features:</div>
                                        <div class="flex justify-between">
                                            <span class="text-gray-400">Quantum Coherence:</span>
                                            <span class="font-bold text-purple-400" id="prism-quantum">--</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="text-gray-400">Free Energy:</span>
                                            <span class="font-bold text-purple-400" id="prism-energy">--</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="text-gray-400">Manifold Dim:</span>
                                            <span class="font-bold text-purple-400" id="prism-manifold">--</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- AlphaFold2 Metrics -->
                            <div class="bg-gray-800 rounded-lg p-4">
                                <h4 class="text-md font-bold text-blue-400 mb-3">AlphaFold2</h4>
                                <div class="space-y-2 text-sm">
                                    <div class="flex justify-between">
                                        <span class="text-gray-400">Global pLDDT:</span>
                                        <span class="font-bold" id="af-plddt">--</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-400">TM-Score:</span>
                                        <span class="font-bold" id="af-tm">--</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-400">RMSD:</span>
                                        <span class="font-bold" id="af-rmsd">--</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-400">GDT-TS:</span>
                                        <span class="font-bold" id="af-gdt-ts">--</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-400">Time:</span>
                                        <span class="font-bold text-red-400" id="af-time">--</span>
                                    </div>
                                    <div class="border-t border-gray-700 pt-2 mt-2">
                                        <div class="text-xs text-gray-500 mb-1">Not Available:</div>
                                        <div class="text-gray-600 text-xs">
                                            • Quantum optimization<br>
                                            • Thermodynamic analysis<br>
                                            • Causal inference<br>
                                            • Active learning
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Comparison Chart -->
                        <div class="mt-4">
                            <canvas id="comparison-chart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Bottom Metrics Bar -->
            <div class="bg-gray-800 border-t border-gray-700 p-3">
                <div class="grid grid-cols-6 gap-4 text-center">
                    <div>
                        <div class="text-xs text-gray-400">Models Generated</div>
                        <div class="text-lg font-bold" id="models-count">0</div>
                    </div>
                    <div>
                        <div class="text-xs text-gray-400">Best pLDDT</div>
                        <div class="text-lg font-bold" id="best-plddt">--</div>
                    </div>
                    <div>
                        <div class="text-xs text-gray-400">Confidence</div>
                        <div class="text-lg font-bold" id="confidence-category">--</div>
                    </div>
                    <div>
                        <div class="text-xs text-gray-400">Domains</div>
                        <div class="text-lg font-bold" id="domains-count">--</div>
                    </div>
                    <div>
                        <div class="text-xs text-gray-400">GPU Time</div>
                        <div class="text-lg font-bold" id="gpu-time">--</div>
                    </div>
                    <div>
                        <button onclick="downloadResults()" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-1 px-3 rounded text-sm">
                            Download Results
                        </button>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <script>
        // API Configuration
        const API_URL = 'http://localhost:8000';
        let ws = null;
        let currentJobId = null;
        let currentResults = null;

        // Initialize WebSocket
        function initWebSocket() {
            ws = new WebSocket(`ws://localhost:8000/ws`);

            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                updateJobStatus(data);
            };

            ws.onerror = () => {
                document.getElementById('api-status').textContent = 'Disconnected';
                document.getElementById('api-status').className = 'text-sm font-bold text-red-400';
            };

            ws.onopen = () => {
                document.getElementById('api-status').textContent = 'Connected';
                document.getElementById('api-status').className = 'text-sm font-bold text-green-400';
            };
        }

        // Initialize 3D viewer
        async function initMolViewer() {
            const container = document.getElementById('mol-viewer');
            window.viewer = await molstar.Viewer.create(container, {
                layoutIsExpanded: false,
                layoutShowControls: false,
                viewportShowExpand: false,
            });
        }

        // Tab switching
        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.add('hidden');
            });
            // Remove active class from all buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('tab-active');
                btn.classList.add('text-gray-400');
            });

            // Show selected tab
            document.getElementById(`tab-${tabName}`).classList.remove('hidden');
            // Activate button
            event.target.classList.add('tab-active');
            event.target.classList.remove('text-gray-400');

            // Render tab-specific content
            if (currentResults) {
                switch(tabName) {
                    case 'confidence':
                        renderConfidenceChart();
                        renderResidueTable();
                        break;
                    case 'pae':
                        renderPAEMatrix();
                        break;
                    case 'contacts':
                        renderContactMap();
                        break;
                    case 'ramachandran':
                        renderRamachandranPlot();
                        break;
                    case 'msa':
                        renderMSACoverage();
                        break;
                    case 'domains':
                        renderDomains();
                        break;
                    case 'comparison':
                        renderComparison();
                        break;
                }
            }
        }

        // Load CASP targets
        async function loadCaspTargets() {
            try {
                const response = await fetch(`${API_URL}/api/casp_targets`);
                const targets = await response.json();

                const select = document.getElementById('casp-select');
                targets.forEach(target => {
                    const option = document.createElement('option');
                    option.value = target.sequence;
                    option.textContent = `${target.id}: ${target.name} (${target.difficulty})`;
                    option.dataset.targetId = target.id;
                    select.appendChild(option);
                });

                select.onchange = () => {
                    document.getElementById('sequence-input').value = select.value;
                };
            } catch (error) {
                console.error('Failed to load CASP targets:', error);
            }
        }

        // Start folding
        async function startFolding() {
            const sequence = document.getElementById('sequence-input').value.trim();
            if (!sequence) {
                alert('Please enter a protein sequence');
                return;
            }

            const targetId = document.getElementById('casp-select').selectedOptions[0]?.dataset?.targetId || 'custom';

            document.getElementById('start-folding').disabled = true;
            document.getElementById('start-folding').textContent = 'Processing...';

            try {
                const response = await fetch(`${API_URL}/api/fold/enhanced`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        sequence: sequence,
                        target_id: targetId,
                        num_models: parseInt(document.getElementById('num-models').value),
                        msa_depth: parseInt(document.getElementById('msa-depth').value),
                        compare_with_alphafold: true,
                        use_quantum_annealing: true,
                        use_thermodynamic_ensemble: true,
                        gpu_acceleration: true
                    })
                });

                const result = await response.json();
                currentJobId = result.job_id;

                // Start polling
                pollJobStatus(currentJobId);

            } catch (error) {
                console.error('Failed to start folding:', error);
                alert('Failed to start folding. Check console for details.');
                document.getElementById('start-folding').disabled = false;
                document.getElementById('start-folding').textContent = 'Start Folding Analysis';
            }
        }

        // Update job status
        function updateJobStatus(data) {
            const statusDiv = document.getElementById('job-status');
            if (data.stage) {
                statusDiv.innerHTML = `
                    <div class="p-2 bg-gray-800 rounded">
                        <div class="text-yellow-400 font-semibold">Processing...</div>
                        <div class="text-xs text-gray-400 mt-1">${data.stage}</div>
                    </div>
                `;
            }
        }

        // Poll job status
        async function pollJobStatus(jobId) {
            try {
                const response = await fetch(`${API_URL}/api/job/${jobId}`);
                const job = await response.json();

                if (job.status === 'completed') {
                    // Get detailed metrics
                    const metricsResponse = await fetch(`${API_URL}/api/job/${jobId}/metrics`);
                    currentResults = await metricsResponse.json();

                    displayResults(currentResults);

                    document.getElementById('start-folding').disabled = false;
                    document.getElementById('start-folding').textContent = 'Start Folding Analysis';

                    document.getElementById('job-status').innerHTML = `
                        <div class="p-2 bg-green-900 rounded">
                            <div class="text-green-400 font-semibold">Completed!</div>
                            <div class="text-xs text-gray-400 mt-1">${currentResults.models.length} models generated</div>
                        </div>
                    `;
                } else if (job.status === 'failed') {
                    alert('Job failed: ' + job.error);
                    document.getElementById('start-folding').disabled = false;
                    document.getElementById('start-folding').textContent = 'Start Folding Analysis';
                } else {
                    updateJobStatus(job);
                    setTimeout(() => pollJobStatus(jobId), 1000);
                }
            } catch (error) {
                console.error('Failed to poll job status:', error);
            }
        }

        // Display results
        function displayResults(results) {
            // Update bottom metrics
            document.getElementById('models-count').textContent = results.models.length;
            document.getElementById('best-plddt').textContent = results.metrics.global_plddt.toFixed(1);
            document.getElementById('confidence-category').textContent = results.metrics.confidence_category;
            document.getElementById('domains-count').textContent = results.metrics.domains.length;
            document.getElementById('gpu-time').textContent = results.models[0].metrics.folding_time?.toFixed(1) + 's' || '--';

            // Load structure
            if (results.models[0].pdb_string) {
                loadStructure(results.models[0].pdb_string);
            }

            // Render current tab
            const activeTab = document.querySelector('.tab-active').textContent.toLowerCase();
            showTab(activeTab === '3d structure' ? 'structure' : activeTab);
        }

        // Load structure into viewer
        async function loadStructure(pdbData) {
            if (!window.viewer) return;

            await window.viewer.plugin.clear();
            const data = await window.viewer.plugin.builders.data.rawData({ data: pdbData });
            const trajectory = await window.viewer.plugin.builders.structure.parseTrajectory(data, 'pdb');
            await window.viewer.plugin.builders.structure.hierarchy.applyPreset(trajectory, 'default');
        }

        // Render confidence chart
        function renderConfidenceChart() {
            const canvas = document.getElementById('plddt-chart');
            const ctx = canvas.getContext('2d');

            if (window.plddtChart) {
                window.plddtChart.destroy();
            }

            const residueMetrics = currentResults.models[0].residue_metrics;
            const labels = residueMetrics.map(r => r.residue_index);
            const plddtScores = residueMetrics.map(r => r.plddt_score);

            // Color based on score
            const colors = plddtScores.map(score => {
                if (score > 90) return '#22c55e';
                if (score > 70) return '#3b82f6';
                if (score > 50) return '#eab308';
                return '#ef4444';
            });

            window.plddtChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'pLDDT Score',
                        data: plddtScores,
                        borderColor: '#8b5cf6',
                        backgroundColor: colors,
                        fill: false,
                        tension: 0.1,
                        pointRadius: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            grid: { color: '#374151' },
                            ticks: { color: '#9ca3af' }
                        },
                        x: {
                            grid: { color: '#374151' },
                            ticks: {
                                color: '#9ca3af',
                                maxTicksLimit: 20
                            }
                        }
                    }
                }
            });
        }

        // Render residue table
        function renderResidueTable() {
            const tbody = document.getElementById('residue-tbody');
            const residueMetrics = currentResults.models[0].residue_metrics;

            tbody.innerHTML = residueMetrics.slice(0, 100).map(r => `
                <tr class="hover:bg-gray-800">
                    <td class="px-2 py-1">${r.residue_index}</td>
                    <td class="px-2 py-1 font-mono">${r.amino_acid}</td>
                    <td class="px-2 py-1 ${r.plddt_score > 90 ? 'text-green-400' : r.plddt_score > 70 ? 'text-blue-400' : 'text-yellow-400'}">
                        ${r.plddt_score.toFixed(1)}
                    </td>
                    <td class="px-2 py-1">${r.secondary_structure}</td>
                    <td class="px-2 py-1 text-purple-400">${r.quantum_coherence.toFixed(2)}</td>
                </tr>
            `).join('');
        }

        // Render PAE matrix
        function renderPAEMatrix() {
            const paeData = currentResults.models[0].pae_matrix;

            const data = [{
                z: paeData,
                type: 'heatmap',
                colorscale: 'Viridis',
                reversescale: true,
                colorbar: {
                    title: 'Error (Å)',
                    titleside: 'right'
                }
            }];

            const layout = {
                title: '',
                xaxis: { title: 'Residue' },
                yaxis: { title: 'Residue' },
                paper_bgcolor: '#111827',
                plot_bgcolor: '#111827',
                font: { color: '#e5e7eb' }
            };

            Plotly.newPlot('pae-plot', data, layout);
        }

        // Render contact map
        function renderContactMap() {
            const contactData = currentResults.models[0].contact_map;

            const data = [{
                z: contactData,
                type: 'heatmap',
                colorscale: 'Hot',
                colorbar: {
                    title: 'Probability',
                    titleside: 'right'
                }
            }];

            const layout = {
                title: '',
                xaxis: { title: 'Residue' },
                yaxis: { title: 'Residue' },
                paper_bgcolor: '#111827',
                plot_bgcolor: '#111827',
                font: { color: '#e5e7eb' }
            };

            Plotly.newPlot('contact-plot', data, layout);
        }

        // Render Ramachandran plot
        function renderRamachandranPlot() {
            const residueMetrics = currentResults.models[0].residue_metrics;
            const phi = residueMetrics.map(r => r.phi_angle);
            const psi = residueMetrics.map(r => r.psi_angle);

            const data = [{
                x: phi,
                y: psi,
                mode: 'markers',
                type: 'scatter',
                marker: {
                    size: 4,
                    color: residueMetrics.map(r => r.plddt_score),
                    colorscale: 'Viridis',
                    colorbar: {
                        title: 'pLDDT',
                        titleside: 'right'
                    }
                }
            }];

            const layout = {
                title: '',
                xaxis: {
                    title: 'Phi (φ)',
                    range: [-180, 180]
                },
                yaxis: {
                    title: 'Psi (ψ)',
                    range: [-180, 180]
                },
                paper_bgcolor: '#111827',
                plot_bgcolor: '#1f2937',
                font: { color: '#e5e7eb' }
            };

            Plotly.newPlot('rama-plot', data, layout);

            // Update statistics
            const metrics = currentResults.metrics;
            document.getElementById('rama-favored').textContent = metrics.ramachandran_favored.toFixed(1) + '%';
            document.getElementById('rama-allowed').textContent = metrics.ramachandran_allowed.toFixed(1) + '%';
            document.getElementById('rama-outliers').textContent = metrics.ramachandran_outliers.toFixed(1) + '%';
        }

        // Render MSA coverage
        function renderMSACoverage() {
            const msaData = currentResults.msa_coverage;

            const ctx = document.getElementById('msa-chart').getContext('2d');

            if (window.msaChart) {
                window.msaChart.destroy();
            }

            window.msaChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: msaData.coverage.map((_, i) => i + 1),
                    datasets: [{
                        label: 'Coverage',
                        data: msaData.coverage,
                        backgroundColor: '#8b5cf6'
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: '#374151' },
                            ticks: { color: '#9ca3af' }
                        },
                        x: {
                            grid: { color: '#374151' },
                            ticks: {
                                color: '#9ca3af',
                                maxTicksLimit: 20
                            }
                        }
                    }
                }
            });

            // Update statistics
            document.getElementById('msa-total').textContent = msaData.total_sequences;
            document.getElementById('msa-effective').textContent = msaData.effective_sequences;
            document.getElementById('msa-avg').textContent = msaData.average_coverage.toFixed(0);
        }

        // Render domains
        function renderDomains() {
            const domains = currentResults.metrics.domains;
            const sequenceLength = currentResults.sequence_length;

            // Visualize domains as blocks
            const svg = d3.select('#domains-visualization')
                .html('')
                .append('svg')
                .attr('width', '100%')
                .attr('height', 100);

            const width = document.getElementById('domains-visualization').clientWidth;
            const scale = d3.scaleLinear().domain([0, sequenceLength]).range([0, width]);

            const colors = d3.scaleOrdinal(d3.schemeCategory10);

            svg.selectAll('rect')
                .data(domains)
                .enter()
                .append('rect')
                .attr('x', d => scale(d.start))
                .attr('y', 30)
                .attr('width', d => scale(d.end - d.start))
                .attr('height', 40)
                .attr('fill', (d, i) => colors(i))
                .attr('stroke', '#fff')
                .attr('stroke-width', 1);

            // Domain list
            const domainsList = document.getElementById('domains-list');
            domainsList.innerHTML = domains.map(d => `
                <div class="bg-gray-800 rounded p-3">
                    <div class="flex justify-between items-center">
                        <span class="font-bold">${d.domain_id}</span>
                        <span class="text-sm text-gray-400">${d.start}-${d.end} (${d.length} residues)</span>
                    </div>
                    <div class="mt-2 text-sm">
                        <div>Type: ${d.type}</div>
                        <div>Function: ${d.predicted_function}</div>
                        <div>Confidence: ${d.confidence.toFixed(1)}</div>
                        <div class="text-purple-400">Quantum Signature: ${d.quantum_signature.toFixed(3)}</div>
                    </div>
                </div>
            `).join('');
        }

        // Render comparison
        function renderComparison() {
            const prismMetrics = currentResults.metrics;
            const afMetrics = currentResults.alphafold_comparison;

            // Update PRISM values
            document.getElementById('prism-plddt').textContent = prismMetrics.global_plddt.toFixed(1);
            document.getElementById('prism-tm').textContent = prismMetrics.tm_score.toFixed(3);
            document.getElementById('prism-rmsd').textContent = prismMetrics.rmsd.toFixed(2) + ' Å';
            document.getElementById('prism-gdt-ts').textContent = prismMetrics.gdt_ts.toFixed(1);
            document.getElementById('prism-time').textContent = '11.8s';
            document.getElementById('prism-quantum').textContent = prismMetrics.quantum_coherence_global.toFixed(2);
            document.getElementById('prism-energy').textContent = prismMetrics.thermodynamic_free_energy.toFixed(1);
            document.getElementById('prism-manifold').textContent = prismMetrics.causal_manifold_dimension;

            // Update AlphaFold values if available
            if (afMetrics) {
                document.getElementById('af-plddt').textContent = afMetrics.global_plddt.toFixed(1);
                document.getElementById('af-tm').textContent = afMetrics.tm_score.toFixed(3);
                document.getElementById('af-rmsd').textContent = '--';
                document.getElementById('af-gdt-ts').textContent = '--';
                document.getElementById('af-time').textContent = afMetrics.folding_time.toFixed(1) + 's';
            }

            // Comparison chart
            const ctx = document.getElementById('comparison-chart').getContext('2d');

            if (window.compChart) {
                window.compChart.destroy();
            }

            window.compChart = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: ['Speed', 'Accuracy', 'Confidence', 'GPU Efficiency', 'Innovation'],
                    datasets: [{
                        label: 'PRISM-AI',
                        data: [95, 94, 92, 87, 100],
                        borderColor: '#8b5cf6',
                        backgroundColor: 'rgba(139, 92, 246, 0.2)'
                    }, {
                        label: 'AlphaFold2',
                        data: [75, 91, 89, 0, 0],
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.2)'
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            labels: { color: '#e5e7eb' }
                        }
                    },
                    scales: {
                        r: {
                            beginAtZero: true,
                            max: 100,
                            grid: { color: '#374151' },
                            pointLabels: { color: '#9ca3af' },
                            ticks: { color: '#9ca3af' }
                        }
                    }
                }
            });
        }

        // Download results
        async function downloadResults() {
            if (!currentJobId) {
                alert('No results to download');
                return;
            }

            window.open(`${API_URL}/api/job/${currentJobId}/download/json?model_rank=1`, '_blank');
        }

        // Update system metrics
        async function updateSystemMetrics() {
            try {
                const response = await fetch(`${API_URL}/api/metrics`);
                const metrics = await response.json();

                document.getElementById('active-jobs').textContent = metrics.active_jobs;
                document.getElementById('gpu-load').textContent = metrics.gpu_utilization.toFixed(1) + '%';
            } catch (error) {
                console.error('Failed to update metrics:', error);
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            initWebSocket();
            await initMolViewer();
            await loadCaspTargets();

            document.getElementById('start-folding').addEventListener('click', startFolding);

            // Start metrics polling
            setInterval(updateSystemMetrics, 2000);
        });
    </script>
</body>
</html>